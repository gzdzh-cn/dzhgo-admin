import{w as e,v as s}from"./@vue.runtime-dom-0c977c95.js";import{d as a}from"./vuedraggable-16c38432.js";import{u as t,d as l}from"./index-c06e60a9.js";import"./vue-echarts-11c03c89.js";import{a as o,e as i}from"./element-plus-961823fe.js";import"./store-52839c99.js";import"./index-4d43d044.js";import{i as n}from"./index.umd.min-b68308bb.js";import{a6 as r,d as p,ag as c,ah as m,ai as d,aj as u,ak as g,B as f}from"./@element-plus.icons-vue-15072d5d.js";import{f as j,C as b,h as k,a5 as v,a9 as y,o as h,c as _,g as x,W as C,a as w,F as z,a3 as V,X as T,_ as D,Z as F,aT as q,aS as M,R as Y,V as A}from"./@vue.runtime-core-dd57a9c9.js";import{h as R,M as $}from"./@vue.reactivity-9aee8bf6.js";import{ak as E,D as H}from"./@vue.shared-dddd31b8.js";import{_ as N}from"./vue-qr-c4264fa6.js";import"./sortablejs-626322a9.js";import"./array.prototype.flat-eee42aa4.js";import"./define-properties-b1343066.js";import"./object-keys-e5f060db.js";import"./has-property-descriptors-6845433e.js";import"./get-intrinsic-cff09dfa.js";import"./has-symbols-a48c7173.js";import"./function-bind-cd5d7d08.js";import"./has-3a5c7287.js";import"./call-bind-cfba7623.js";import"./es-abstract-253c30b8.js";import"./has-proto-93b28181.js";import"./gopd-1516b43e.js";import"./is-regex-74a42cfc.js";import"./has-tostringtag-ad4fd641.js";import"./is-callable-99eeba16.js";import"./object-inspect-66cad57c.js";import"./es-to-primitive-6664914a.js";import"./is-date-object-d2231eea.js";import"./is-symbol-3a29a1ce.js";import"./safe-regex-test-183ad494.js";import"./es-shim-unscopables-89146e87.js";import"./vue-6d1d317a.js";import"./vue-router-17136280.js";import"./monaco-editor-c28fb00f.js";import"./axios-6b2fb661.js";import"./nprogress-64657d8f.js";import"./lodash-es-8394daf0.js";import"./@vueuse.core-3c960f69.js";import"./@vueuse.shared-2b88397c.js";import"./pinia-efddbf44.js";import"./vue-demi-71ba0ef2.js";import"./mockjs-0b3ee9ca.js";import"./merge-4bdec194.js";import"./mitt-2d52b530.js";import"./clone-deep-53153407.js";import"./shallow-clone-d419fbda.js";import"./kind-of-d78bf752.js";import"./is-plain-object-40c8282f.js";import"./isobject-c886ab54.js";import"./resize-detector-2312ef2b.js";import"./echarts-e550b62f.js";import"./tslib-a4e99503.js";import"./zrender-f72fb7be.js";import"./@ctrl.tinycolor-d9b9bf03.js";import"./@popperjs.core-b696b006.js";import"./dayjs-89173748.js";import"./async-validator-ff95bfc9.js";import"./memoize-one-63ab667a.js";import"./escape-html-1935ddb3.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui.dom-92665be4.js";import"./@floating-ui.core-c1b3624a.js";import"./js-binary-schema-parser-814ef804.js";const O=e=>(q("data-v-7b4626ac"),e=e(),M(),e),S={class:"view-task"},U={class:"box"},W={class:"header"},B={class:"label"},G={class:"num"},I=O((()=>w("span",{class:"flex1"},null,-1))),X={class:"op-btn"},Z=O((()=>w("span",null,"刷新",-1))),J=["onClick"],K=O((()=>w("span",null,"添加",-1))),L=["data-id","onContextmenu"],P={class:"h"},Q={class:"name"},ee={class:"remark"},se={class:"f"},ae={class:"date"},te=O((()=>w("span",{class:"start"},"进行中",-1))),le=O((()=>w("span",null,"...",-1))),oe=O((()=>w("span",{class:"stop"},"已停止",-1))),ie={class:"op"},ne=["onClick"],re=O((()=>w("span",null,"开始",-1))),pe=["onClick"],ce=O((()=>w("span",null,"暂停",-1))),me=["onClick"],de=O((()=>w("span",null,"编辑",-1))),ue=["onClick"],ge=O((()=>w("span",null,"查看日志",-1))),fe={key:0,class:"empty"},je={class:"footer"},be=["onClick"],ke={class:"block _log"},ve={class:"header"},ye=O((()=>w("span",{class:"label"},"日志",-1))),he={class:"num"},_e=O((()=>w("span",{class:"flex1"},null,-1))),xe={class:"op-btn"},Ce=O((()=>w("span",null,"刷新",-1))),we={class:"container","element-loading-text":"拼命加载中"},ze=["infinite-scroll-disabled"],Ve=["onClick"],Te={class:"h"},De={class:"name"},Fe={class:"f"},qe={key:0,class:"empty"},Me=j({name:"task"}),Ye=N(j({...Me,setup(j){const{refs:q,setRefs:M,service:N}=t(),O=R([{key:"sys",label:"系统任务",icon:"el-icon-s-tools",list:[],loading:!1,params:{type:0,status:1},pagination:{size:10,page:1,total:0}},{key:"user",label:"用户自定义任务",icon:"el-icon-user-solid",list:[],loading:!1,params:{type:1,status:1},pagination:{size:10,page:1,total:0}},{key:"stop",label:"已停止任务",list:[],loading:!1,params:{type:null,status:0},pagination:{size:10,page:1,total:0}}]),Me=R({loading:!1,list:[],pagination:{size:10,page:1},params:{},filters:{status:[]},current:null}),Ye=R({options:{group:"Task",animation:300,ghostClass:"Ghost",dragClass:"Drag",draggable:"._drag"}}),Ae=b((()=>N.task.info.permission));function Re(e,{list:s,pagination:a}){if(!e)return;const{page:t,size:l}=e.pagination,o=e.list.length,i=s.length;if(1==t)s.splice(0,i,...e.list);else{const a=i-i%l,t=a+o;s.splice(a,t,...e.list)}return o==l&&(e.pagination.page+=1),Object.assign(a,e.pagination),1!=t}function $e(e,s){const{index:a,more:t}=s||{};(null==a?O.map(((e,s)=>s)):[a]).forEach((async s=>{const a=O[s];Object.assign(a.params,{...a.pagination,...e}),a.loading=!0;Re(await N.task.info.page(a.params),a),t||q[`${a.key}-scroller`].scroll({top:0,behavior:"smooth"}),a.loading=!1}))}const Ee=n.useForm();async function He(e){var s;const{id:a,type:t}=e||{};let l={type:t,service:"",name:"",cron:""};a&&(l=await N.task.info.info({id:a})),l.every&&(l.every/=1e3),l.limit||(l.limit=void 0),null==(s=Ee.value)||s.open({title:"编辑任务",width:"600px",props:{labelWidth:"80px"},items:[{label:"名称",prop:"name",component:{name:"el-input",props:{placeholder:"请输入名称"}},rules:{required:!0,message:"名称不能为空"}},{label:"类型",prop:"taskType",value:0,component:{name:"el-select",options:[{label:"cron",value:0},{label:"时间间隔",value:1}],props:{onChange(e){var s,a;0==e?null==(s=Ee.value)||s.setForm("every",void 0):null==(a=Ee.value)||a.setForm("cron",void 0)}}}},{label:"cron",prop:"cron",hidden:({scope:e})=>1==e.taskType,component:{name:"el-input",props:{placeholder:"* * * * * *"}},rules:{required:!0,message:"cron不能为空"}},{label:"间隔(秒)",prop:"every",hidden:({scope:e})=>0==e.taskType,component:{name:"el-input-number",props:{min:1,max:1e8}},rules:{required:!0,message:"执行间隔不能为空"}},{label:"service",prop:"service",component:{name:"el-input",props:{placeholder:"taskDemoService.test([1, 2])"}}},{label:"开始时间",prop:"startDate",hidden:({scope:e})=>1==e.taskType,component:{name:"el-date-picker",props:{type:"datetime","value-format":"YYYY-MM-DD HH:mm:ss"}}},{label:"备注",prop:"remark",component:{name:"el-input",props:{type:"textarea"}}},{label:"状态",prop:"status",value:0,component:{name:"el-radio-group",options:[{label:"停止",value:0},{label:"运行",value:1}]}}],form:{...l},on:{submit:(e,{close:s,done:t})=>{e.limit||(e.limit=null),N.task.info[a?"update":"add"]({...l,...e,every:1e3*e.every}).then((()=>{$e(),o.success("保存成功"),s()})).catch((e=>{o.error(e.message),t()}))}}})}function Ne({id:e,type:s}){N.task.info.start({id:e,type:s}).then((()=>{$e()})).catch((e=>{o.error(e.message)}))}function Oe({id:e}){N.task.info.stop({id:e}).then((()=>{$e()})).catch((e=>{o.error(e.message)}))}function Se({to:e,item:s}){const a=e.getAttribute("data-status"),t=e.getAttribute("data-type"),l=s.getAttribute("data-id");0==a&&Oe({id:l}),1==a&&Ne({id:l,type:t})}async function Ue(e,s){if(Me.loading)return!1;if(!l(Ae.value.log))return!1;const{params:a,pagination:t}=Me,{more:o}=s||{};Object.assign(a,{...t,...e}),Me.loading=!0;Re(await N.task.info.log(a),Me),o||q["log-scroller"].scroll({top:0,behavior:"smooth"}),Me.loading=!1}function We(){Ue(null,{more:!0})}function Be(e){Me.current=e,Ue({page:1,id:e.id})}function Ge(){Me.current=null,Ue({page:1,id:null})}function Ie([e]){Ue({page:1,status:void 0===e?1:0})}function Xe(e,{id:s,status:a,type:t,name:r}){const p=[{label:"立即执行",perm:["once"],callback(e){!function({id:e}){N.task.info.once({id:e}).then((()=>{$e()})).catch((e=>{o.error(e.message)}))}({id:s}),e()}},{label:"编辑",perm:["update","info"],callback(e){He({id:s,type:t}),e()}},{label:"删除",perm:["delete"],callback(e){!function({id:e}){i.confirm("此操作将永久删除该任务，是否继续？","提示",{type:"warning"}).then((()=>{N.task.info.delete({ids:[e]}).then((()=>{$e()}))})).catch((()=>null))}({id:s}),e()}},{label:"查看日志",perm:["log"],callback(e){Be({id:s,name:r}),e()}}];return 1==a?p.splice(1,0,{label:"暂停",perm:["stop"],callback(e){Oe({id:s,type:t}),e()}}):p.splice(1,0,{label:"开始",perm:["start"],callback(e){Ne({id:s,type:t}),e()}}),n.ContextMenu.open(e,{list:p.filter((e=>l({and:e.perm.map((e=>Ae.value[e]))})))}),!1}return k((()=>{$e({page:1})})),(t,l)=>{const o=v("el-icon"),i=v("el-button"),n=v("el-checkbox"),j=v("el-checkbox-group"),b=v("el-scrollbar"),k=v("cl-form"),q=y("permission"),R=y("infinite-scroll"),N=y("loading");return h(),_("div",S,[x(b,null,{default:C((()=>[w("div",U,[(h(!0),_(z,null,V(O,((t,n)=>(h(),_("div",{key:n,class:H(["block",[`_${t.key}`]])},[w("div",W,[w("i",{class:H(["icon",t.icon])},null,2),w("span",B,E(t.label),1),w("span",G,"("+E(t.pagination.total)+")",1),I,w("ul",X,[T((h(),_("li",{class:"refresh-btn",onClick:l[0]||(l[0]=e=>$e({page:1}))},[x(o,null,{default:C((()=>[x($(r))])),_:1}),Z])),[[q,$(Ae).delete]]),T((h(),_("li",{class:"add-btn",onClick:e=>He(t.params)},[x(o,null,{default:C((()=>[x($(c))])),_:1}),K],8,J)),[[q,$(Ae).add]])])]),w("div",{ref_for:!0,ref:$(M)(`${t.key}-scroller`),class:"container scroller1"},[x($(a),Y({modelValue:O[n].list,"onUpdate:modelValue":e=>O[n].list=e},Ye.options,{tag:"ul","item-key":"id","data-type":t.params.type,"data-status":t.params.status,onEnd:Se}),{item:C((({element:a})=>[(h(),_("li",{key:a.id,"data-id":a.id,class:"_drag",onContextmenu:e((e=>Xe(e,a)),["stop","prevent"])},[w("div",P,[T(w("span",{class:"type _warning"},E(0===a.type?"系统":"用户"),513),[[s,0===a.status]]),w("span",Q,E(a.name),1)]),w("div",ee,E(a.remark),1),w("div",se,[a.status?(h(),_(z,{key:0},[w("span",ae,E(a.nextRunTime||"..."),1),te],64)):(h(),_(z,{key:1},[le,oe],64))]),w("div",ie,[0===a.status?(h(),_("div",{key:0,class:"op-item",onClick:e=>Ne(a)},[x(o,null,{default:C((()=>[x($(m))])),_:1}),re],8,ne)):T((h(),_("div",{key:1,class:"op-item",onClick:e=>Oe(a)},[x(o,null,{default:C((()=>[x($(d))])),_:1}),ce],8,pe)),[[q,$(Ae).stop]]),T((h(),_("div",{class:"op-item",onClick:e=>He(a)},[x(o,null,{default:C((()=>[x($(u))])),_:1}),de],8,me)),[[q,{and:[$(Ae).update,$(Ae).info]}]]),T((h(),_("div",{class:"op-item",onClick:e=>Be(a)},[x(o,null,{default:C((()=>[x($(g))])),_:1}),ge],8,ue)),[[q,$(Ae).log]])])],40,L))])),header:C((()=>[0==O[n].list.length?(h(),_("div",fe," 暂无数据 ")):F("",!0)])),_:2},1040,["modelValue","onUpdate:modelValue","data-type","data-status"]),t.pagination.total>=t.pagination.size?(h(),A(i,{key:0,class:"more",text:"",onClick:e=>function(e){$e(null,{index:e,more:!0})}(n)},{default:C((()=>[D("查看更多")])),_:2},1032,["onClick"])):F("",!0)],512),w("div",je,[T((h(),_("button",{class:"btn-add",onClick:e=>He(t.params)},[x(o,null,{default:C((()=>[x($(f))])),_:1})],8,be)),[[q,$(Ae).add]])])],2)))),128)),T((h(),_("div",ke,[w("div",ve,[ye,w("span",he,"("+E(Me.pagination.total)+")",1),_e,x(j,{modelValue:Me.filters.status,"onUpdate:modelValue":l[1]||(l[1]=e=>Me.filters.status=e),class:"status",onChange:Ie},{default:C((()=>[x(n,{label:0},{default:C((()=>[D("异常")])),_:1})])),_:1},8,["modelValue"]),w("ul",xe,[w("li",{onClick:l[2]||(l[2]=e=>Ue({page:1}))},[x(o,null,{default:C((()=>[x($(r))])),_:1}),Ce]),Me.current?(h(),_("li",{key:0,class:"_current-log",onClick:Ge},[w("span",null,E(Me.current.name),1),x(o,null,{default:C((()=>[x($(p))])),_:1})])):F("",!0)])]),T((h(),_("div",we,[T((h(),_("ul",{ref:$(M)("log-scroller"),class:"scroller1","infinite-scroll-disabled":Me.list.length==Me.pagination.total},[(h(!0),_(z,null,V(Me.list,((e,s)=>(h(),_("li",{key:s,class:H({_error:0==e.status}),onClick:s=>{var a;(a=e)._expand=!a._expand}},[w("div",Te,[w("span",De,E(Number(s)+1)+" · "+E(e.taskName),1)]),w("div",{class:H(["remark",{_ellipsis:!e._expand}])},E(e.detail||"..."),3),w("div",Fe,[w("span",null,"执行时间："+E(e.createTime),1)])],10,Ve)))),128)),0==Me.list.length?(h(),_("div",qe,"暂无数据")):F("",!0)],8,ze)),[[R,We]])])),[[N,Me.loading]])])),[[q,$(Ae).log]])])])),_:1}),x(k,{ref_key:"Form",ref:Ee},null,512)])}}}),[["__scopeId","data-v-7b4626ac"]]);export{Ye as default};
