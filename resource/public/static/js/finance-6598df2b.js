import{i as e}from"./index.umd.min-b68308bb.js";import{b as o,f as t,u as l}from"./index-c06e60a9.js";import"./vue-echarts-11c03c89.js";import"./element-plus-961823fe.js";import"./store-52839c99.js";import"./index-4d43d044.js";import{a8 as r}from"./@element-plus.icons-vue-15072d5d.js";import{d as a}from"./dayjs-89173748.js";import{f as p,h as s,a5 as n,o as i,V as u,W as m,a as d,g as c,_ as v}from"./@vue.runtime-core-dd57a9c9.js";import{r as y}from"./@vue.reactivity-9aee8bf6.js";import{ak as j}from"./@vue.shared-dddd31b8.js";import"./array.prototype.flat-eee42aa4.js";import"./define-properties-b1343066.js";import"./object-keys-e5f060db.js";import"./has-property-descriptors-6845433e.js";import"./get-intrinsic-cff09dfa.js";import"./has-symbols-a48c7173.js";import"./function-bind-cd5d7d08.js";import"./has-3a5c7287.js";import"./call-bind-cfba7623.js";import"./es-abstract-253c30b8.js";import"./has-proto-93b28181.js";import"./gopd-1516b43e.js";import"./is-regex-74a42cfc.js";import"./has-tostringtag-ad4fd641.js";import"./is-callable-99eeba16.js";import"./object-inspect-66cad57c.js";import"./es-to-primitive-6664914a.js";import"./is-date-object-d2231eea.js";import"./is-symbol-3a29a1ce.js";import"./safe-regex-test-183ad494.js";import"./es-shim-unscopables-89146e87.js";import"./vue-6d1d317a.js";import"./@vue.runtime-dom-0c977c95.js";import"./vue-router-17136280.js";import"./monaco-editor-c28fb00f.js";import"./axios-6b2fb661.js";import"./nprogress-64657d8f.js";import"./lodash-es-8394daf0.js";import"./@vueuse.core-3c960f69.js";import"./@vueuse.shared-2b88397c.js";import"./pinia-efddbf44.js";import"./vue-demi-71ba0ef2.js";import"./mockjs-0b3ee9ca.js";import"./merge-4bdec194.js";import"./mitt-2d52b530.js";import"./clone-deep-53153407.js";import"./shallow-clone-d419fbda.js";import"./kind-of-d78bf752.js";import"./is-plain-object-40c8282f.js";import"./isobject-c886ab54.js";import"./resize-detector-2312ef2b.js";import"./echarts-e550b62f.js";import"./tslib-a4e99503.js";import"./zrender-f72fb7be.js";import"./@ctrl.tinycolor-d9b9bf03.js";import"./@popperjs.core-b696b006.js";import"./async-validator-ff95bfc9.js";import"./memoize-one-63ab667a.js";import"./escape-html-1935ddb3.js";import"./normalize-wheel-es-3222b0a2.js";import"./@floating-ui.dom-92665be4.js";import"./@floating-ui.core-c1b3624a.js";const b={style:{padding:"10px 10px 0px 20px",display:"flex","flex-wrap":"wrap","row-gap":"10px"}},f=d("div",{class:"divider"},null,-1),h=["innerHTML"],g=p({name:"crm-finance"}),x=p({...g,setup(p){const{user:g}=o(),x=y(1!=g.info.id),{dict:C}=t(),{service:M}=l(),w=y("in"),k=y(!1),Y=()=>{k.value=!k.value};s((()=>{N()}));const D=e.useUpsert({items:[{label:"下单者",prop:"uid",required:!0,value:g.info.id,hidden:()=>1!=g.info.id,component:{name:"el-select",options:[],props:{}}},{label:"项目订单",span:12,prop:"orderCode",component:{name:"slot-orderCode"}},()=>({label:"收款",prop:"receiveMoney",span:12,hidden:({scope:e})=>{var o;return"add"==(null==(o=D.value)?void 0:o.mode)?"in"!==w.value:"in"!==e.type},component:{name:"el-input-number",props:{suffixIcon:r,min:0}}}),()=>({label:"支出",prop:"expenditureMoney",span:12,hidden:({scope:e})=>{var o;return"add"==(null==(o=D.value)?void 0:o.mode)?"out"!==w.value:"out"!==e.type},component:{name:"el-input-number",props:{suffixIcon:r,min:0}}}),{label:"种类",prop:"species",span:12,value:"company",component:{name:"el-select",options:C.get("species")}},{label:"结算方式",prop:"paytype",span:12,required:!0,component:{name:"el-select",options:C.get("paytype")}},{label:"结算日期",prop:"payDate",span:12,required:!0,value:a().format("YYYY-MM-DD"),component:{name:"el-date-picker",props:{type:"date",valueFormat:"YYYY-MM-DD"}}},{label:"备注",prop:"remark",component:{name:"el-input",props:{type:"textarea",rows:4}}}],async onOpen(e){var o,t,l,r,a,p,s,n;if(1==g.info.id){const e=await M.base.sys.user.list();null==(o=D.value)||o.setOptions("uid",e.map((e=>({label:e.nickName||"",value:e.id||""}))))}"update"==(null==(t=D.value)?void 0:t.mode)&&await W(e.orderCode),"add"==(null==(l=D.value)?void 0:l.mode)&&("in"==w.value&&(null==(r=D.value)||r.setTitle("新增收入")),"out"==w.value&&(null==(a=D.value)||a.setTitle("新增支出"))),"update"==(null==(p=D.value)?void 0:p.mode)&&(w.value=e.type,"in"==e.type&&(null==(s=D.value)||s.setTitle("编辑收入")),"out"==e.type&&(null==(n=D.value)||n.setTitle("编辑支出")))},onSubmit(e,{next:o}){var t,l,r,a;let p={projectNum:null==(t=e.orderCode)?void 0:t.split("-")[0],type:w.value,incomeAndOut:e.receiveMoney,orderId:null==(l=L.value[e.orderCode])?void 0:l.id,orderType:null==(r=L.value[e.orderCode])?void 0:r.orderType};e.expenditureMoney&&(p.incomeAndOut="-"+e.expenditureMoney),1!=(null==(a=g.info)?void 0:a.id)&&(p.uid=g.info.id),o({...e,...p})}}),T=e.useTable({columns:[{type:"selection"},{label:"下单者",prop:"userName",hidden:x},{label:"项目订单",prop:"orderCode"},{label:"收支",prop:"incomeAndOut"},{label:"种类",prop:"species",dict:{text:!0,separator:"",options:C.get("species").value}},{label:"结算方式",prop:"paytype",dict:{text:!0,separator:"",options:C.get("paytype").value}},{label:"结算日期",prop:"payDate",component:{name:"cl-date-text",props:{format:"YYYY-MM-DD"}}},{label:"备注",prop:"remark",showOverflowTooltip:!0,minWidth:150},{type:"op",buttons:["edit","delete"]}]}),_=e.useCrud({service:M.crm.finance,async onRefresh(e,{next:o,render:t}){let l;I.value?(I.value=!1,l=await M.crm.finance.list({size:1e4,month:1})):l=await M.crm.finance.list(e),t(l)}});s((()=>{A({size:1e4,month:1})}));const A=e=>{var o;null==(o=_.value)||o.refresh(e)},O=y(),N=async()=>{const e=(await M.base.sys.user.list()).map((e=>({label:e.nickName||"",value:e.id||""})));return O.value=e,O},z=e.useAdvSearch({items:[()=>({label:"下单者",prop:"uid",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...O.value]}}}),{label:"月份",prop:"month",component:{name:"cl-select",props:{options:[{label:"全部",value:""},{label:"近一个月",value:"1"},{label:"近二个月",value:"2"},{label:"近三个月",value:"3"},{label:"近半年",value:"6"},{label:"近一年",value:"12"}]}}},{label:"种类",prop:"species",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...C.get("species").value]}}},{label:"收支类型",prop:"type",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...C.get("type").value]}}},{label:"结算方式",prop:"paytype",component:{name:"cl-select",props:{options:[{label:"全部",value:""},...C.get("paytype").value]}}},{label:"时间",prop:"dateTime",component:{name:"el-date-picker",props:{type:"daterange",startPlaceholder:"开始日期",endPlaceholder:"结束日期",value:"YYYY-MM-DD",valueFormat:"YYYY-MM-DD",disabledDate:e=>e.getTime()>Date.now()}}}]}),I=y(!1),V=()=>{var e;I.value=!0,null==(e=_.value)||e.refresh()},F=({column:e})=>"expenditureMoney"==e.property?"expenditureMoney":"receiveMoney"==e.property?"receiveMoney":void 0,q=e=>{var o;w.value=e,null==(o=D.value)||o.add()},L=y({}),S=y([]),U=y(!1),W=async e=>{if(""!==e){U.value=!0;const o=await M.crm.order.list({keyWord:e});U.value=!1,S.value=o.map((e=>{L.value[e.orderCode]=e;const o=$(e.orderType);return{label:(null==o?void 0:o.label)+"-"+e.orderCode,value:e.orderCode}}))}},$=e=>{const o=C.get("orderType").value.filter((o=>o.value==e));if(o.length>0)return o[0];const t=C.get("subOrderType").value.filter((o=>o.value==e));return t.length>0?t[0]:{}},H=y(),P=e=>{H.value=e},R=({row:e,column:o,rowIndex:t,columnIndex:l})=>{var r;if(t===Number(null==(r=T.value)?void 0:r.data.length)){if(0===l)return[1,2];if(1===l)return[0,0]}},B=e=>{const{columns:o,data:t}=e;return["","合计","",`￥ ${t.reduce(((e,o)=>parseFloat(e+Number(o.incomeAndOut))),0).toFixed(2)}`]},E=e=>{let o;return null==e||e.expenditureMoney,o="in"==(null==e?void 0:e.type)?`<span style="color:#f74848"> 收 : ${null==e?void 0:e.incomeAndOut} </span> 元`:`<span style="color:#4165d7"> 支 : ${null==e?void 0:e.incomeAndOut}  </span>  元`,o};return(e,o)=>{const t=n("cl-refresh-btn"),l=n("cl-multi-delete-btn"),r=n("cl-search-key"),a=n("cl-adv-btn"),p=n("cl-flex1"),s=n("DArrowLeft"),y=n("el-icon"),g=n("el-button"),x=n("cl-table"),C=n("cl-row"),M=n("el-select-v2"),w=n("cl-upsert"),A=n("cl-adv-search"),O=n("cl-crud");return i(),u(O,{ref_key:"Crud",ref:_},{default:m((()=>[d("div",b,[c(t),c(l,{style:{"margin-right":"10px"}}),c(r),c(a),c(p),c(g,{plain:"",onClick:Y,style:{"margin-right":"10px"}},{default:m((()=>[c(y,null,{default:m((()=>[c(s)])),_:1}),v(" "+j(k.value?"收起":"展开"),1)])),_:1}),c(g,{type:"primary",onClick:o[0]||(o[0]=e=>q("in"))},{default:m((()=>[v("新增收入")])),_:1}),c(g,{type:"danger",onClick:o[1]||(o[1]=e=>q("out"))},{default:m((()=>[v("新增支出")])),_:1}),c(g,{test:"",bg:"",onClick:V},{default:m((()=>[v("清除条件")])),_:1})]),f,c(C,null,{default:m((()=>[c(x,{ref_key:"Table",ref:T,border:!1,cellClassName:F,headerCellClassName:F,"span-method":R,"summary-method":B,"show-summary":"",onSelectionChange:P},{"column-incomeAndOut":m((({scope:e})=>[d("div",{style:{"text-align":"left"},innerHTML:E(e.row)},null,8,h)])),_:1},512)])),_:1}),c(C,null,{default:m((()=>[c(p)])),_:1}),c(w,{ref_key:"Upsert",ref:D},{"slot-orderCode":m((({scope:e})=>[c(M,{modelValue:e.orderCode,"onUpdate:modelValue":o=>e.orderCode=o,filterable:"",remote:"","remote-method":W,clearable:"",options:S.value,loading:U.value,placeholder:"请输入订单号"},null,8,["modelValue","onUpdate:modelValue","options","loading"])])),_:1},512),c(A,{ref_key:"AdvSearch",ref:z},null,512)])),_:1},512)}}});export{x as default};
